<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <title>yaVDR RESTful API</title>
    <style>textarea.materialize-textarea{height: 4rem;}
      </style>
    </head>

<body>
    <div class="container">
        <h1>yaVDR RESTful API Documentation</h1>
        <p class="flow-text">
          yaVDR provides a RESTful api service for status information and administrative purposes (which is used by the included web frontend).
          This documentation should enable you to write own clients if you feel the need to integrate yaVDR in your environment.
        </p>
        <h2>How to use this API documentation</h2>
        <p class="flow-text">You may browse the API routes without authentication, but if you wish to send requests to the API and see response data, you must authenticate. All routes return JSON data.
        Obtain a session cookie by <code>POST</code>ing to the <code>/api/login/</code> route or a token by <code>POST</code>ing to the <code>/api/login/token</code> route with you local username and password.
        </p>
        
        <div class="card">
          <div class="card-content">
            <span class="card-title"><h2>Authentication</h2></span>
            <p class="flow-text">
              Access is granted based on PAM authentication, so you can login with a local username and password. The groups of the user at login time are used to determine the permissions for protected routes. In order to gain full access, you user must be a member of the group <code>sudo</code>. Members of the group <code>adm</code> are allowed to use the <code>/api/log/</code> routes. All authenticated users are allowed to access the <code>/api/status/</code> and <code>/api/hitkey/</code> routes.
            </p>
            <ul class="collapsible" data-collapsible="expandable">
               <li>
                <div class="collapsible-header">
                    <h5><code>/api/login</code></h5><span class="badge"><h5>POST</h5></span>
                </div>
                <div class="collapsible-body">
                  <div class="section">
                    <h4>Implementation Notes</h4>
                    <p class="flow-text">
                        Sending a <code>POST</code> request with correct login data on <code>/api/login</code> sets a session cookie.
                    </p>
                  </div>
                  <div class="section">
                    <h4>Parameters</h4>
                    <h5>Parameter Content Type:</h5>
                    <code>application/json</code>
                    <p class="flow-text">
                        You must send a JSON string using the following model schema:
                        <pre><code>{
  "username": "string",
  "password": "string"
}</code></pre>
                    </p>
                  </div>
                  <div class="section">
                    <h4>Response Messages</h4>
                    <h5>Response Content Type:</h5>
                    <code>application/json</code>
                    <h5>Status Code: <code>200</code></h5>
                    <p class="flow-text">Successfull authentication. A session cookie is set. Returns a JSON message:
                        <pre><code>{
  "msg": "login successfull"
}
                        </code></pre>
                    </p>
                    <h5>Status Code: <code>401</code></h5>
                    <pre><code>{
  "message": "invalid username or password"
}</code></pre>
                  </div>
                  
                  <p class="flow-text">Try the form below to see the API call in action:</p>
                    <div class="divider"></div>
                    <div class="row">
                        <form class="col s12">
                          <div class="row">
                            <div class="input-field col s6">
                                <input type="text" id="username_input"><br>
                                <label for="username_input">Username</label>
                            </div>
                            <div class="input-field col s6">
                                <input type="password" id="password_input">
                                <label for="password_input">Password</label>
                            </div>
                          </div>
                          <button class="btn waves-effect waves-light" type="button" name="login" id="CookieLogin">
                          Login (POST) <i class="material-icons right">send</i>
                          </button>
                        </form>
                    </div>
                    <p class="flow-text">sent JSON data:</p>
                    <pre id="login_data"></pre>
                    <p class="flow-text">JSON response:</p>
                    <pre id="login_response"></pre>
                    <p class="flow-text">Status Code: <code id="login_status_code"></code></p>
                 </div>
               </li>
               <li>
                 <div class="collapsible-header">
                    <h5><code>/api/login</code></h5><span class="badge"><h5>GET</h5></span>
                 </div>
                 <div class="collapsible-body">
                   <div class="section">
                     <h4>Implementation Notes</h4>
                     <p class="flow-text">
                       Sending a <code>GET</code> request can be used to check if the session cookie
                       (or the token obtained with the method below) is valid. 
                     </p>
                   </div>
                   <div class="section">
                     <h4>Parameters</h4>
                     <p class="flow-text">None</p>
                   </div>
                   <div class="section">
                     <h4>Response Messages</h4>
                     <h5>Response Content Type:</h5>
                     <code>application/json</code>
                     <h5>Status Code: <code>200</code></h5>
                     <p class="flow-text">Authentication successfull. Returns a JSON message with the following schema:
                         <pre><code>{
  "groups": [
    [
      "string",
    ]
  ],
  "msg": "string",
  "username": "string"
}</code></pre>
                      </p>
                     <h5>Status Code: <code>401</code></h5>
                     <pre><code>{
  "msg": "invalid authorization, please log in and try again"
}</code></pre>
                     
                   </div>
                   
                   <p class="flow-text">Try the form below to see the API calls in action:</p>
                   <div class="divider"></div>
                   <button class="btn waves-effect waves-light" type="button" name="checklogin" id="test">
                     Check Login (GET) <i class="material-icons right">send</i>
                   </button>
                   <p class="flow-text">JSON response:</p>
                   <pre id="login_state_response"></pre>
                   <p class="flow-text">Status Code: <code id="login_state_status_code"></code></p>
                 </div>
               </li>
               <li>
                 <div class="collapsible-header"><h5><code>/api/login/token</code></h5><span class="badge"><h5>POST</h5></span></div>
                 <div class="collapsible-body">
                  <div class="section">
                    <h4>Implementation Notes</h4>
                    <p class="flow-text">
                      Sending a <code>POST</code> request with correct login data on <code>/api/login/token</code> returns a token.
                      You can validate the token with the <code>GET</code> method of <code>/api/login</code> (see above).
                      In order to use the token for further API requests, you must send a header field with the token information:
                      <pre>Authorization: Bearer YOUR_TOKEN</pre>
                      </br>Use the form and the buttons below to try it:
                    </p>
                  </div>
                  <div class="section">
                    <h4>Response Class (Status 200)</h4>
                    <p class="flow-text">Returns a JSON message:
                        <pre><code>{
  "msg": "string"
  "token": "string"                            
}</code></pre>
                    </p>
                    <h5>Response Content Type:</h5>
                    <code>application/json</code>
                  </div>
                  <div class="section">
                    <h4>Parameters</h4>
                    <p class="flow-text">
                        You must send a JSON string using the following model schema:
                        <pre><code>{
  "username": "string",
  "password": "string"
}</code></pre>
                    </p>
                    <h5>Parameter Content Type:</h5>
                    <code>application/json</code>
                  </div>
                  <div class="section">
                    <h4>Response Messages</h4>
                    <h5>Status Code: <code>401</code></h5>
                    <pre><code>{
  "message": "invalid username or password"
}</code></pre>
                  </div>
                    <div class="divider"></div>
                    <div class="row">
                        <form class="col s12">
                          <div class="row">
                            <div class="input-field col s6">
                                <input type="text" id="username_token_input"><br>
                                <label for="username_token_input">Username</label>
                            </div>
                            <div class="input-field col s6">
                                <input type="password" id="password_token_input">
                                <label for="password_token_input">Password</label>
                            </div>
                          </div>
                            <button class="btn waves-effect waves-light" type="button" name="login_token" id="TokenLogin">
                            Login (POST) <i class="material-icons right">send</i>
                            </button>
                            <button class="btn tooltipped waves-effect waves-light"
                                    type="button" name="token_delete" id="Tokenlogout"
                                    data-delay="50" data-position="top" data-tooltip="delete local storage">
                              Delete Token
                            </button>
                        </form>
                    </div>
                    <p class="flow-text">login JSON data:</p>
                    <pre id="login_token_data" readonly></pre>
                    <p class="flow-text">JSON response:</p>
                    <pre id="login_token_response"></pre>
                    <p class="flow-text">Status Code: <code id="login_token_status_code"></code></p>
                 </div>
               </li>
               <li>
                 <div class="collapsible-header">
                    <code><h5>/api/logout</code></h5><span class="badge"><h5>GET POST</h5></span>
                 </div>
                 <div class="collapsible-body">
                    <p class="flow-text">
                      Calling this route invalidates the session cookie.<br>
                      </br>Press the button below to try it:
                    </p>
                    <button class="btn waves-effect waves-light" type="button" name="token_delete" id="logout">Logout</button>
               </li>
               
                
             </ul>
            <div>
        </div>
    <!--     <div> -->
    <!--         <button id="press_ok">Press KEY_OK</button> -->
    <!--     </div> -->
    <!--     <div> -->
    <!--         <p id="login_result">Click one of the buttons above for action!</p> -->
    <!--     </div> -->
    <!-- </div> -->

  <script type="text/javascript">
  $(document).ready(function() {
    $('#test').click(function() {
      $.ajax({
        type: 'GET',
        url: '/api/login',
        <!--contentType: 'application/json; charset=UTF-8',-->
        beforeSend: function(xhr) {
          if (localStorage.token) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token);
          }
          $('#login_data').text(JSON.stringify({
           }, null, 2));
        },
        success: function(data) {
          Materialize.toast("Hello " + data.username + "!<br>You are authenticated.", 4000, "rounded");
        },
        error: function() {
          Materialize.toast("Sorry, you are not logged in.", 4000);
        },
        complete: function(data) {
          $('#login_state_response').text(JSON.stringify(data.responseJSON, null, 2));
          $('#login_state_status_code').text(data.status);
        },
      });
    });
    $('#CookieLogin').click(function() {
      $.ajax({
        type: "POST",
        url: "/api/login",
        contentType: 'application/json; charset=UTF-8',
        dataType: 'json',
        data: JSON.stringify({
          "username": $('#username_input').val(),
          "password": $('#password_input').val()
        }),
        beforeSend: function() {
          $('#login_data').text(JSON.stringify({
          "username": $('#username_input').val(),
          "password": $('#password_input').val()
           }, null, 2));
        },
        success: function(data) {
          $('#login_result').text('Got a session cookie from the server!');
          Materialize.toast('Login successfull.', 4000, 'rounded')
        },
        error: function(data) {
          Materialize.toast('Login failed.', 4000)
        },
        complete: function(data) {
          $('#login_response').text(JSON.stringify(data.responseJSON, null, 2));
          $('#login_status_code').text(data.status);
        },
      });
    });
    $('#TokenLogin').click(function() {
      $.ajax({
        type: "POST",
        url: "/api/login/token",
        contentType: 'application/json; charset=UTF-8',
        dataType: 'json',
        data: JSON.stringify({
          "username": $('#username_token_input').val(),
          "password": $('#password_token_input').val()
        }),
        beforeSend: function() {
          $('#login_token_data').text(JSON.stringify({
          "username": $('#username_token_input').val(),
          "password": $('#password_token_input').val()
           }, null, 2));
        },
        success: function(data) {
          localStorage.token = data.token;
          Materialize.toast('Login successfull.', 4000, 'rounded')
        },
        error: function() {
          Materialize.toast('Login failed.', 4000)
        },
        complete: function(data) {
          $('#login_token_response').text(JSON.stringify(data.responseJSON, null, 2));
          $('#login_token_status_code').text(data.status);
        },
      });
    });

    $('#logout').click(function() {
      $.ajax({
        type: "GET",
        url: "/logout",
      })
      $('#login_result').text("Logged out.");
    });
    $('#Tokenlogout').click(function() {
      localStorage.clear();
      Materialize.toast('Deleted local storage.', 4000)
    });
    $('#press_ok').click(function() {
      $.ajax({
        type: "POST",
        url: "/api/hitkey/KEY_OK",
        success: function(data) {
          $('#login_result').text("hitkey:" + data.msg);
        },
        error: function() {
          $('#login_result').text("Sending key failed");
        },
      })
    });
  });
  </script>
</body>

</html>
